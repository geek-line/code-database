<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel='icon' href='/static/favicon.ico'>
    <title>Code Database</title>
    <link rel='stylesheet' href='/node_modules/tinymce/skins/content/default/content.min.css'>
    <link rel='stylesheet' href='/node_modules/tinymce/skins/ui/oxide/content.min.css'>
    <script src="/node_modules/tinymce/tinymce.min.js" referrerpolicy="origin"></script>
    <link rel='stylesheet' href='/node_modules/materialize-css/dist/css/materialize.min.css'>
    <link rel='stylesheet' href='/static/css/user_details.css/'>
</head>

<body>
    {{ template "header" .Header }}

    <div class="p_items_wrapper row">
        <div class= "p_action_item col s0 m0 l1  hide-on-small-only">
            <div class='display_like'>
                <div class='balloon'><span id='likes' class='like_number'>{{ .DetailPage.Likes }}</span></div>
                <form id="like_form" class="like">
                    <input id="knowledge_id" type='hidden' name="id" value="{{ .DetailPage.ID }}">
                    <button class="like-button" id ="like_button" type='button' value="like" onclick="sendLike()">LIKE</button>
                </form>
                <input id="input" type='hidden' value="{{ .DetailPage.Content }}">
            </div>
        </div>
            <div class= "p_main_item col s12 m12 l8">
                <ul class="tags">   
                    {{ range .DetailPage.SelectedTags }}
                    <li><a href='/tags/{{ .ID }}'>{{ .Name }}</a></li>
                    {{ end }}
                </ul>
                <div class= "title">{{ .DetailPage.Title }}</div>
                <div class= "update_time">最終更新日時:{{ .DetailPage.UpdatedAt }}</div>
                <br/>
                <div id="content" class="content"></div>
                <p></p>
                
            </div>
            <div class= "p_table_items col s0 m0 l3 ">
                <div id="p_table_items" class= "item"></div>
            </div>
        </div>

    {{ template "footer" }}
</body>
<script type="text/javascript">
    const content = document.getElementById('content')
    const input = document.getElementById('input')
    const like_button = document.getElementById('like_button')
    const likes = document.getElementById('likes')
    const knowledge_id = document.getElementById('knowledge_id').value

    


    document.addEventListener('DOMContentLoaded', function () {
        if (localStorage.getItem('noLoginLike')) {
            let value = localStorage.getItem('noLoginLike')
            let values = value.split(',')
            for (let i = 0; i < values.length; i++) {
                if (values[i] == knowledge_id) {
                    like_button.textContent = 'LIKED'
                    like_button.classList.add('liked-button')
                    break
                }
            }
        }
        content.innerHTML = input.value
        var contentsList = document.getElementById("p_table_items"); // 目次を追加する先(table of contents)
        var div = document.createElement('div'); // 作成する目次のコンテナ要素

        // .entry-content配下のh2、h3要素を全て取得する
        var matches = document.querySelectorAll('.content h2,.content h3');
        

        // .entry-content配下のh2、h3要素を全て取得する
     

        // 取得した見出しタグ要素の数だけ以下の操作を繰り返す
        matches.forEach(function (value, i) {
            // 見出しタグ要素のidを取得し空の場合は内容をidにする
            var id = value.id;
            if(id === '') {
                id = value.textContent;
                value.id = id;
            }

            // 要素がh2タグの場合
            if(value.tagName === 'H2') {
                var ul = document.createElement('ul');
                var li = document.createElement('li');
                var a = document.createElement('a');

                // 追加する<ul><li><a>タイトル</a></li></ul>を準備する
                a.innerHTML = value.textContent;
                a.href = '#' + value.id;
                li.appendChild(a)
                ul.appendChild(li);

                // コンテナ要素である<div>の中に要素を追加する
                div.appendChild(ul);
            }

            // 要素がh3タグの場合
            if(value.tagName === 'H3') {
                var ul = document.createElement('ul');
                var li = document.createElement('li');
                var a = document.createElement('a');

                // コンテナ要素である<div>の中から最後の<li>を取得する。
                var lastUl = div.lastElementChild;
                var lastLi = lastUl.lastElementChild;

                // 追加する<ul><li><a>タイトル</a></li></ul>を準備する
                a.innerHTML = '&nbsp; ->'+value.textContent;
                a.href = '#' + value.id;
                li.appendChild(a)
                ul.appendChild(li);

                // 最後の<li>の中に要素を追加する
                lastLi.appendChild(ul);
            }
        });

        // 最後に画面にレンダリング
        contentsList.appendChild(div);
    });


    // window.addEventListener('DOMContentLoaded', function(){
   
    //     content.innerHTML = input.value

    //     var contentsList = document.getElementById("p_table_items"); // 目次を追加する先(table of contents)
    //     var div = document.createElement('div'); // 作成する目次のコンテナ要素

    //     // .entry-content配下のh2、h3要素を全て取得する
    //     var matches = document.querySelectorAll('.content h2');
        
    //     // 取得した見出しタグ要素の数だけ以下の操作を繰り返す
    //     matches.forEach(function (value, i) {
    //         // 見出しタグ要素のidを取得し空の場合は内容をidにする
    //         var id = value.id;
    //         if(id === '') {
    //             id = value.textContent;
    //             value.id = id;
    //         }
    //             var ul = document.createElement('ul');
    //             var li = document.createElement('li');
    //             var a = document.createElement('a');
    //             // 追加する<ul><li><a>タイトル</a></li></ul>を準備する
    //             a.innerHTML = value.textContent;
    //             a.href = '#' + value.id;
    //             li.appendChild(a)
    //             ul.appendChild(li);
    //             div.appendChild(ul);
    //             // コンテナ要素である<div>の中に要素を追加する
    //     })
    //     contentsList.appendChild(div);
    // });
    function sendLike(){
        let values = []
        let value = ''
        if (localStorage.getItem('noLoginLike')){
            value = localStorage.getItem('noLoginLike')
            values = value.split(',')
        }
       
        let isFound = false
        for (let i = 0; i < values.length; i++){
            if(values[i] == knowledge_id){
                console.log('hi')
                values.splice(i, 1)
                value = values.join()
                isFound = true
                break
            }
        }
        if (!isFound){
            values.push(knowledge_id)
            value = values.join()
        }
       
        const XHR = new XMLHttpRequest()
        let formdata = new FormData(like_form)
        if (isFound) {
            XHR.open('PUT', '/knowledges/like')
        }else{
            XHR.open('POST', '/knowledges/like')
        }
        XHR.onreadystatechange = function () {
            if (XHR.readyState === 4) {
                if (XHR.status === 200) {
                    if(isFound){
                        likes.textContent = Number(likes.textContent) - 1
                        like_button.textContent = 'LIKE'
                        like_button.classList.remove('liked-button')
                    }else{
                        likes.textContent = Number(likes.textContent) + 1
                        like_button.textContent = 'LIKED'
                        like_button.classList.add('liked-button')
                    }
                    localStorage.setItem('noLoginLike', value)
                } else {
                    alert('データが正常に送れませんでした')
                }
            }
        }
        XHR.send(formdata)
    }
</script>
</html>
